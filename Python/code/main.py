from flask import Flask
from flask import request
from flask_cors import CORS

from signature_detector import hasher
from anomaly_detector.PE_main import apply_anomaly
import requests

app = Flask(__name__)

CORS(app)


@app.route("/upload_test", methods=["POST"])
def upload():
    if "file" not in request.files:
        return {"message": "No file part"}, 400

    file = request.files["file"]

    if file.filename == "":
        return {"message": "No selected file"}, 400

    return file.filename


@app.route("/check_signature", methods=["POST"])
def check_signature():
    if "file" not in request.files:
        return {"message": "No file uploaded"}, 400

    file = request.files["file"]

    if file.filename == "":
        return {"message": "No selected file"}, 400

    file_hash = hasher.calculate_sha256(file)

    response = requests.post(
        "https://mb-api.abuse.ch/api/v1/",
        data={"query": "get_info", "hash": str(file_hash)},
    )

    if response.json()["query_status"] == "ok":
        return {"is_malware": True}

    return {"is_malware": False}


@app.route("/check_anomaly", methods=["POST"])
def check_anomaly():
    if "file" not in request.files:
        return {"message": "No file uploaded"}, 400

    file = request.files["file"]

    if file.filename == "":
        return {"message": "No selected file"}, 400

    file_name = hasher.calculate_sha256(file)

    file.seek(0)

    verdict = apply_anomaly(file, str(file_name))

    return {"is_malware_anomaly": verdict}


@app.route("/")
def hello_world():
    return "Hello, World!"


if __name__ == "__main__":
    app.run(debug=True, port=5001)
