const express = require("express");
const axios = require("axios");
const fs = require("fs");
const FormData = require("form-data");
const chokidar = require("chokidar");
const path = require("path");
const cors = require("cors");

const app = express();
const port = 8080;

//CONST
const INTERVAL = 5000;
const directoryPath = "./drop_area";
const outputPath = "./output/result.csv";

let programSignature = [];
let programAnomaly = [];
let programQueue = [];
let programProcess = [];
let completedQueue = [];
let sandboxStatus = true;
let signatureStatus = true;
let anomalyStatus = true;

const recordCSVInit = () => {
  let writeStreamInit = fs.createWriteStream(outputPath, { flags: "w" });
  writeStreamInit.write("timestamp,job_id,file_name,file_hash,stage,verdict\n");
  writeStreamInit.end();
  console.log("Record File Initiated");
};

const recordCSV = (data) => {
  //Configure
  let record_data = {
    job_id: data.job_id,
    file_name: data.file_name,
    file_hash: "NULL",
    stage: data.stage,
    verdict: data.verdict,
  };
  let writeStream = fs.createWriteStream(outputPath, { flags: "a" });
  writeStream.write(
    `${new Date()},${record_data.job_id},${record_data.file_name},${
      record_data.file_hash
    },${record_data.stage},${record_data.verdict}\n`
  );
  writeStream.end();
};

const processSignature = () => {
  console.log("Running Signature");
  if (programQueue.length != 0) {
    let that_file = {
      file_name: programQueue.shift(),
      stage: "SIGNATURE",
      date_created: new Date(),
    };
    let formData = new FormData();
    formData.append(
      "file",
      fs.createReadStream("./drop_area/" + that_file.file_name)
    );
    axios
      .post("http://localhost:5001/check_signature", formData)
      .then((res) => {
        if (res.data.is_malware == false) {
          processAnomaly(that_file);
        } else {
          that_file.verdict = "Malicious (from Signature Detection)";
          that_file.job_id = "N/A";
          that_file.state = "SUCCESS";
          recordCSV(that_file);
          completedQueue.push(that_file);
        }
        console.log("Signature Completed");
      })
      .catch((err) => {
        console.log(
          "Error processing " + that_file.file_name + " at Signature analysis"
        );
        programQueue.push(that_file.file_name);
      });
  }
};

const processAnomaly = (this_file) => {
  console.log("Running Anomaly");
  let that_file = this_file;
  that_file.stage = "ANOMALY";
  let formData = new FormData();
  formData.append(
    "file",
    fs.createReadStream("./drop_area/" + that_file.file_name)
  );
  axios
    .post("http://localhost:5001/check_anomaly", formData)
    .then((res) => {
      if (res.data.is_malware_anomaly == "legitimate") {
        processSandbox(this_file);
      } else if (res.data.is_malware_anomaly == "malicious") {
        that_file.verdict = "Malicious (from Anomaly Detection)";
        that_file.job_id = "N/A";
        that_file.state = "SUCCESS";
        completedQueue.push(that_file);
      } else {
        that_file.verdict = "Anomaly detection error";
        that_file.job_id = "N/A";
        that_file.state = "ERROR";
        recordCSV(that_file);
        completedQueue.push(that_file);
      }
      console.log("Anomaly Completed");
    })
    .catch((err) => {
      console.log(
        "Error processing " + that_file.file_name + " at Anomaly analysis"
      );
      that_file.stage = "SIGNATURE";
      programQueue.push(that_file.file_name);
    });
};

const processSandbox = (this_file) => {
  let that_file = this_file;
  that_file.stage = "SANDBOX";
  let formData = new FormData();
  formData.append(
    "file",
    fs.createReadStream("./drop_area/" + that_file.file_name)
  );
  formData.append("environment_id", "160");

  let url = "https://www.hybrid-analysis.com/api/v2/submit/file";
  axios
    .post(url, formData, {
      headers: {
        ...formData.getHeaders(),
        // Add any additional headers if required
        "api-key":
          "j1a9ao95e83eac814426pakt304e8d0e7pspgeya9caf21c690tsj1o1bb350da8",
      },
    })
    .then((res) => {
      res.data.file_name = that_file.file_name;
      res.data.stage = that_file.stage;
      res.data.date_created = that_file.date_created;
      programProcess.push(res.data);
      console.log("Add new processing data:" + that_file.file_name);
    })
    .catch((err) => {
      console.log(
        "Error processing " + that_file.file_name + " at Sandbox analysis"
      );
      that_file.stage = "ANOMALY";
      programQueue.push(that_file.file_name);
    });
};

const processCheckState = () => {
  for (let i = 0; i < programProcess.length; i++) {
    let job_id = programProcess[i].job_id;

    let formData = new FormData();

    axios
      .get(
        "https://www.hybrid-analysis.com/api/v2/report/" + job_id + "/state",
        {
          headers: {
            ...formData.getHeaders(),
            // Add any additional headers if required
            "api-key":
              "j1a9ao95e83eac814426pakt304e8d0e7pspgeya9caf21c690tsj1o1bb350da8",
          },
        }
      )
      .then((res) => {
        if (res.data.state == "SUCCESS") {
          axios
            .get(
              "https://www.hybrid-analysis.com/api/v2/report/" +
                job_id +
                "/summary",
              {
                headers: {
                  ...formData.getHeaders(),
                  // Add any additional headers if required
                  "api-key":
                    "j1a9ao95e83eac814426pakt304e8d0e7pspgeya9caf21c690tsj1o1bb350da8",
                },
              }
            )
            .then((resp) => {
              resp.data.file_name = programProcess[i].file_name;
              resp.data.stage = "SANDBOX";
              resp.data.date_created = programProcess[i].date_created;
              completedQueue.push(resp.data);
              recordCSV(resp.data);
              programProcess.splice(i, 1);
            });
        } else if (res.data.state == "ERROR") {
          let err_output = programProcess[i];
          err_output.state = "ERROR";
          err_output.stage = "SANDBOX";
          err_output.verdict = "Error at Sandbox";
          recordCSV(err_output);
          completedQueue.push(programProcess[i]);
          programProcess.splice(i, 1);
        }
      });
  }
};

const watcher = chokidar.watch(directoryPath, { persistent: true });

// Event listener for added files
watcher.on("add", (filePath) => {
  const fileName = path.basename(filePath);
  programQueue.push(fileName);
  console.log(`New file added: ${fileName}`);
});

// Error handling
watcher.on("error", (error) => {
  console.error(`Error: ${error}`);
});

// Ready event when the watcher is ready
watcher.on("ready", () => {
  recordCSVInit();
  // Read the initial list of files in the directory
  fs.readdir(directoryPath, (err, files) => {
    if (err) {
      console.error(`Error reading directory: ${err}`);
      return;
    }

    console.log("Watching for changes...");
    setInterval(processSignature, INTERVAL);
    setInterval(processCheckState, INTERVAL);
  });
});

app.use(cors());

// Define a route for handling HTTP requests
app.get("/", (req, res) => {
  res.send("Ping");
});

app.get("/sandbox", (req, res) => {
  res.send(programProcess);
});

app.get("/anomaly", (req, res) => {
  res.send(programAnomaly);
});

app.get("/signature", (req, res) => {
  res.send(programSignature);
});

app.get("/completed", (req, res) => {
  res.send(completedQueue);
});

// Start the Express server
app.listen(port, () => {
  console.log(`Server listening at http://localhost:${port}`);
});
